- name: Set switchInterfaces configure session name
  tags: arista, interfaces
  set_fact:
    configSession: interfaces-{{ ansible_date_time.iso8601_basic }}
    configExitAction: abort

- name: Create configure session
  tags: arista, interfaces
  arista.eos.eos_command:
    commands:
     - configure session {{ configSession }}

- name: Configure vlan trunk interfaces
  tags: arista, interfaces
  arista.eos.eos_command:
    commands:
     - interface Ethernet {{ item.number }}
     - description {{ item.description }}
     - switchport mode trunk 
     - "{{ ( item.vlans is defined and item.vlans|length) | ternary('switchport trunk allowed vlan ', 'no switchport trunk allowed vlan', '') + item.vlans | default() }}"
     - "{{ ( item.vlanNative is defined and item.vlanNative|length) | ternary('switchport trunk native vlan ', 'no switchport trunk native vlan', '') + item.vlanNative | default() }}"
     - "{{ item.shutdown | ternary('shutdown', 'no shutdown', omit) }}"
  loop: "{{ switchInterfaces }}"
  when: item.vlanMode is defined and item.vlanMode == "trunk"

- name: Configure vlan access interfaces
  tags: arista, interfaces
  arista.eos.eos_command:
    commands:
     - interface Ethernet {{ item.number }}
     - description {{ item.description }}
     - switchport mode access
     - switchport access vlan {{ item.vlans }}
     - "{{ item.shutdown | ternary('shutdown', 'no shutdown', omit) }}"
  loop: "{{ switchInterfaces }}"
  when: item.vlanMode is defined and item.vlanMode == "access"

- name: Configure non vlan interfaces
  tags: arista, interfaces
  arista.eos.eos_command:
    commands:
     - interface Ethernet {{ item.number }}
     - description {{ item.description }}
     - "{{ item.shutdown | ternary('shutdown', 'no shutdown', omit) }}"
  loop: "{{ switchInterfaces }}"
  when: item.vlanMode is not defined
  
- name: Configure interfaces with optional commands
  tags: arista, interfaces
  arista.eos.eos_command:
    commands: "{{ switchInterfacesCommands }}"
  when: switchInterfacesCommands|length

- name: Timer commit configure session
  tags: arista, interfaces
  arista.eos.eos_command:
    commands:
     - commit timer 00:01:00

- name: Did our interfaces session fail?
  tags: arista, interfaces
  pause:
    seconds: 10

- name: Reconsider config exit action
  tags: arista, basic
  set_fact:
    configExitAction: commit
    writeMePlease: true

- name: Commit configure session
  arista.eos.eos_command:
    commands:
     - configure session {{ configSession }} {{ configExitAction }}
